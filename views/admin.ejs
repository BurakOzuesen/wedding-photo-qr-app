<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - <%= event.eventName %></title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container">
      <section class="card">
        <div class="row wrap between">
          <div>
            <h1><%= event.eventName %></h1>
            <% if (event.eventDate) { %>
              <p class="muted"><%= event.eventDate %></p>
            <% } %>
          </div>
          <div class="row wrap">
            <a class="button" href="/admin/<%= event.id %>/download.zip">ZIP Indir</a>
            <a class="button ghost" href="/">Yeni Etkinlik</a>
          </div>
        </div>

        <div class="row wrap">
          <img src="<%= qrDataUrl %>" alt="QR Code" class="qr small" />
          <div class="stack grow">
            <label>
              Misafir Linki
              <input type="text" readonly value="<%= joinUrl %>" />
            </label>
            <p class="muted small">Admin oturumu bu tarayicida guvenli cerez ile korunur.</p>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="row wrap between">
          <h2>Gelenler (<%= uploads.length %>)</h2>
          <p id="gallery-visible-count" class="muted small"></p>
        </div>

        <% if (!uploads.length) { %>
          <p class="muted">Henuz yukleme yok.</p>
        <% } else { %>
          <div class="toolbar">
            <label>
              Ara
              <input id="filter-query" type="search" placeholder="Dosya veya isim ara" />
            </label>
            <label>
              Medya Tipi
              <select id="filter-type">
                <option value="all">Hepsi</option>
                <option value="image">Sadece Foto</option>
                <option value="video">Sadece Video</option>
              </select>
            </label>
            <label>
              Siralama
              <select id="sort-order">
                <option value="newest">En Yeni</option>
                <option value="oldest">En Eski</option>
                <option value="name-asc">Dosya Adi (A-Z)</option>
                <option value="name-desc">Dosya Adi (Z-A)</option>
              </select>
            </label>
          </div>

          <div class="grid" id="media-grid">
            <% uploads.forEach((item) => { %>
              <article
                class="media-card"
                data-mime="<%= item.mimeType %>"
                data-name="<%= item.originalName %>"
                data-guest="<%= item.guestName || '' %>"
                data-uploaded-at="<%= item.uploadedAt %>"
              >
                <% if (item.viewUrl) { %>
                  <% if (item.mimeType.startsWith("image/")) { %>
                    <img src="<%= item.viewUrl %>" alt="<%= item.originalName %>" />
                  <% } else { %>
                    <video controls preload="metadata">
                      <source src="<%= item.viewUrl %>" type="<%= item.mimeType %>" />
                    </video>
                  <% } %>
                <% } else { %>
                  <div class="meta">
                    <p class="muted small">Dosya onizlemesi olusturulamadi.</p>
                  </div>
                <% } %>
                <div class="meta">
                  <p><%= item.originalName %></p>
                  <p class="muted small">
                    <%= item.guestName ? item.guestName : "Anonim" %> - <%= new Date(item.uploadedAt).toLocaleString("tr-TR") %>
                  </p>
                </div>
              </article>
            <% }) %>
          </div>
        <% } %>
      </section>
    </main>

    <script>
      const mediaGrid = document.getElementById("media-grid");
      if (mediaGrid) {
        const filterQuery = document.getElementById("filter-query");
        const filterType = document.getElementById("filter-type");
        const sortOrder = document.getElementById("sort-order");
        const visibleCountEl = document.getElementById("gallery-visible-count");
        const mediaCards = Array.from(mediaGrid.querySelectorAll(".media-card"));

        const normalize = (value) => String(value || "").toLocaleLowerCase("tr-TR");

        const getUploadedAt = (card) => {
          const parsed = Date.parse(card.dataset.uploadedAt || "");
          return Number.isNaN(parsed) ? 0 : parsed;
        };

        const sortCards = (cards, mode) =>
          cards.slice().sort((cardA, cardB) => {
            if (mode === "oldest") {
              return getUploadedAt(cardA) - getUploadedAt(cardB);
            }
            if (mode === "name-asc") {
              return normalize(cardA.dataset.name).localeCompare(normalize(cardB.dataset.name), "tr");
            }
            if (mode === "name-desc") {
              return normalize(cardB.dataset.name).localeCompare(normalize(cardA.dataset.name), "tr");
            }
            return getUploadedAt(cardB) - getUploadedAt(cardA);
          });

        const applyGalleryControls = () => {
          const query = normalize(filterQuery.value.trim());
          const type = filterType.value;
          const order = sortOrder.value;
          let visibleCount = 0;

          const sortedCards = sortCards(mediaCards, order);
          sortedCards.forEach((card) => {
            const mime = card.dataset.mime || "";
            const name = normalize(card.dataset.name);
            const guest = normalize(card.dataset.guest);

            const typeMatch =
              type === "all" ||
              (type === "image" && mime.startsWith("image/")) ||
              (type === "video" && mime.startsWith("video/"));

            const queryMatch = !query || `${name} ${guest}`.includes(query);
            const visible = typeMatch && queryMatch;

            card.hidden = !visible;
            mediaGrid.appendChild(card);

            if (visible) {
              visibleCount += 1;
            }
          });

          visibleCountEl.textContent = `Gorunen: ${visibleCount}/${mediaCards.length}`;
        };

        filterQuery.addEventListener("input", applyGalleryControls);
        filterType.addEventListener("change", applyGalleryControls);
        sortOrder.addEventListener("change", applyGalleryControls);
        applyGalleryControls();
      }
    </script>
  </body>
</html>
